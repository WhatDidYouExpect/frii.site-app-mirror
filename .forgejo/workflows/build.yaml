name: Android Build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-android:
    runs-on: [docker]

    env:
      FLUTTER_VERSION: "3.19.6"
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_HOME: ${{ github.workspace }}/android-sdk

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl unzip zip git \
            openjdk-17-jdk \
            libglu1-mesa

      - name: Install Flutter
        run: |
          curl -L https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz \
            -o flutter.tar.xz
          tar xf flutter.tar.xz
          echo "$PWD/flutter/bin" >> $GITHUB_PATH
          flutter --version

      - name: Install Android SDK
        run: |
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT

          curl -L https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip \
            -o cmdline-tools.zip

          unzip cmdline-tools.zip
          mv cmdline-tools cmdline-tools/latest

          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

      - name: Accept licenses & install SDK packages
        run: |
          yes | sdkmanager --licenses

          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-release
          path: build/app/outputs/
